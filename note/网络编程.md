# 网络编程

## TCP协议

TCP协议是一种面向连接的协议，在java中使用方法如下。

服务器端：

```java
//创建服务器，设置端口为6666
ServerSocket server = new ServerSocket(6666);
System.out.println("服务器创建完毕，等待连接。。。");

//创建通讯套接字，创建后会一直监听并阻塞，直到建立连接
Socket socket = server.accept();
System.out.println(socket.getLocalAddress());	//连接成功，输出IP地址（本机127.0.0.1）

//通过流来进行通讯,getInputStream可以使用InputStreamReader转换为字节流
BufferedReader bs = new BufferedReader(new InputStreamReader(socket.getInputStream()));

//读取，如果没读取到会一直阻塞
String s = bs.readLine();
System.out.println(s);

//使用打印流输出。
PrintStream ps = new PrintStream(new BufferedOutputStream(socket.getOutputStream()));
ps.print("echo:"+s);
ps.flush();

ps.close();
bs.close();
```



客户端:

```java
//创建通讯套接字，并设置要通讯的地址和端口
Socket socket = new Socket("127.0.0.1",6666);

//使用流来通讯
PrintStream ps = new PrintStream(new BufferedOutputStream(socket.getOutputStream()));
ps.println("Hello World!");
ps.flush();

BufferedReader br = new BufferedReader(new InputStreamReader(socket.getInputStream()));

String info = br.readLine();
System.out.println(info);

br.close();
ps.close();
```



可以看到，建立TCP通讯并不复杂，建立之后使用流可以完成通讯。和C++使用类似，但底层原理需要另外学习。



### 服务器连接多个客户端

可以使用线程实现，具体如下：

```java
ExecutorService es = Executors.newFixedThreadPool(3);	//创建线程池，线程数为3

try {
    ServerSocket server = new ServerSocket(6666);
    System.out.println("服务器已创建，等待连接");

    //不断的监听，当有连接时会通过线程进行处理
    while (true){
        Socket socket = server.accept();    //监听
        UserThread ut = new UserThread(socket);

        es.execute(ut);
    }
} catch (IOException e) {
    e.printStackTrace();
}

class UserThread implements Runnable{
    private Socket s = null;
    public UserThread(Socket s) {
        this.s = s;
    }

    @Override
    public void run() {
        try {
            System.out.println(s.getInetAddress().getHostAddress());
            BufferedReader br = new BufferedReader(
                				new InputStreamReader(s.getInputStream()));
            PrintStream ps = new PrintStream(
                			 new BufferedOutputStream(s.getOutputStream()));

            String info = br.readLine();
            System.out.println(br);

            ps.println("Echo:"+info);
            ps.flush();

            ps.close();
            br.close();

            System.out.println(Thread.currentThread().getName());
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```